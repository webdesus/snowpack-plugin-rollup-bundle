{"version":3,"file":"index.js","sources":["../dist-src/options.js","../dist-src/proxyImportResolver.js","../dist-src/utils.js","../dist-src/manifestUtils.js","../dist-src/emitHtmlFiles.js","../dist-src/index.js"],"sourcesContent":["import path from \"path\"; // plugins\n\nimport resolve from \"@rollup/plugin-node-resolve\";\nimport commonjs from \"@rollup/plugin-commonjs\";\nimport styles from \"rollup-plugin-styles\";\nimport { terser } from \"rollup-plugin-terser\";\nimport url from \"@rollup/plugin-url\";\nimport sourcemaps from \"rollup-plugin-sourcemaps\";\nexport function defaultInputOptions({\n  buildDirectory,\n  tmpDir,\n  sourcemap\n}) {\n  const plugins = [resolve({\n    browser: true\n  }), styles({\n    mode: [\"extract\", \"app.css\"],\n    autoModules: id => id.includes(\".module.css\"),\n    minimize: true,\n    sourceMap: sourcemap\n  }), url({\n    include: \"**/*\",\n    exclude: \"**/*.(js|json|css)\",\n    destDir: path.resolve(tmpDir),\n    sourceDir: path.resolve(buildDirectory),\n    limit: 0,\n    // extract all files\n    fileName: \"[dirname]/[name]-[hash][extname]\"\n  }), commonjs()];\n\n  if (sourcemap) {\n    plugins.push(sourcemaps());\n  }\n\n  return {\n    plugins\n  };\n}\nexport function defaultOutputOptions(buildDirectory) {\n  return {\n    format: \"es\",\n    plugins: [terser()],\n    manualChunks: id => {\n      if (id.includes(\"web_modules\")) {\n        return path.parse(id).name;\n      }\n    },\n    assetFileNames: \"css/[name]-[hash].[ext]\",\n    chunkFileNames: \"chunks/[name]-[hash].chunk.js\",\n    compact: true,\n    sourcemap: true,\n    entryFileNames: \"[name]-[hash].js\",\n    dir: buildDirectory\n  };\n}","// https://github.com/pikapkg/snowpack/blob/master/plugins/plugin-webpack/plugins/proxy-import-resolve.js\nexport function proxyImportResolver(source) {\n  const regex = /import.*['\"].*\\.(\\w+)\\.proxy\\.js['\"]/g;\n  return source.replace(regex, (fullMatch, originalExt) => {\n    // no JSON plugin loaded\n    if (originalExt === \"json\") {\n      return fullMatch;\n    }\n\n    return fullMatch.replace(\".proxy.js\", \"\");\n  });\n}","import path from \"path\";\nimport { spawnSync } from \"child_process\";\n/**\n * Normalizes \\\\ on windows to /\n * @param {string} filePath - Normalizes \\ to / on windows.\n */\n\nexport function pathToUnix(filePath) {\n  if (path.sep === \"\\\\\") {\n    return filePath.replace(/\\\\/g, \"/\");\n  }\n\n  return filePath;\n}\nexport function parseHashFileName(filePath) {\n  const {\n    dir,\n    base\n  } = path.parse(filePath);\n  const fileWithoutHash = base.replace(/(.*)-\\w+(\\.\\w+)/g, \"$1$2\");\n  return pathToUnix(path.join(dir, fileWithoutHash));\n}\nexport function shellRun(cmd, options = {}) {\n  options.stdio = options.stdio || \"inherit\";\n  options.shell = options.shell || true;\n  options.encoding = options.encoding || \"utf8\";\n  return spawnSync(cmd, options);\n}\nexport function prependSlash(fileName) {\n  if (fileName[0] === \"/\") {\n    return fileName;\n  }\n\n  return \"/\" + fileName;\n}","import { pathToUnix, prependSlash, parseHashFileName } from \"./utils.js\";\nimport path from \"path\";\nexport function addToManifest({\n  manifest,\n  chunkOrAsset,\n  assignTo,\n  useFileType = true\n}) {\n  const {\n    fileName\n  } = chunkOrAsset;\n  const asset = chunkOrAsset;\n  const assignment = assignTo;\n  manifest[parseHashFileName(fileName)] = prependSlash(fileName);\n  manifest[assignment] = manifest[assignment] || {};\n  assignAsset({\n    obj: manifest[assignment],\n    asset,\n    useFileType\n  });\n}\n\nfunction assignAsset({\n  obj,\n  asset,\n  useFileType\n}) {\n  const {\n    map,\n    fileName\n  } = asset;\n  let fileType = extType(fileName);\n  let baseName;\n  baseName = parseHashFileName(fileName);\n\n  if (baseName === undefined) {\n    return;\n  } // js / js.map / css / css.map files do not use an extension.\n\n\n  if (fileType !== null) {\n    // Split at the first . just in case it has multiple extensions IE: .css.map\n    let {\n      dir,\n      name\n    } = path.parse(baseName);\n\n    if (fileType.startsWith(\"css\")) {\n      dir = dir.split(\"/\").slice(2).join(\"\");\n    } else if (fileType.startsWith(\"js\")) {\n      dir = dir.split(\"/\").slice(1).join(\"\");\n    }\n\n    baseName = pathToUnix(path.join(dir, name.split(\".\")[0]));\n  }\n\n  const adjustedFileName = prependSlash(fileName);\n  obj[baseName] = obj[baseName] || {};\n\n  if (useFileType === false) {\n    obj[baseName] = adjustedFileName;\n    return;\n  }\n\n  obj[baseName][fileType] = adjustedFileName;\n\n  if (map) {\n    const mapFile = adjustedFileName + \".map\";\n    fileType = extType(mapFile);\n    obj[baseName][fileType] = mapFile;\n  }\n}\n\nfunction extType(fileName) {\n  if (fileName.endsWith(\".css.map\")) {\n    return \"css.map\";\n  } else if (fileName.endsWith(\".css\")) {\n    return \"css\";\n  } else if (fileName.endsWith(\".js.map\")) {\n    return \"js.map\";\n  } else if (fileName.endsWith(\".js\")) {\n    return \"js\";\n  }\n\n  return null;\n}","import fs from \"fs\";\nimport path from \"path\";\nimport { pathToUnix, parseHashFileName, prependSlash } from \"./utils.js\";\nimport { JSDOM } from \"jsdom\";\n/**\n * An instance of JSDOM\n * @typedef {string} JSDOM\n */\n\n/**\n * A manifest file parsed to an Object\n * @typedef {Object} ManifestObject\n */\n\n/**\n * Rewrites the values of scripts and extrapolates the css file\n *   associated with the script.\n *\n * @param {Object} params\n * @param {string} params.file - Path to a file\n * @param {ManifestObject} params.manifest - Manifest Object\n * @param {string} params.destFile - Path to the new file\n * @returns {undefined}\n */\n\nexport function emitHtmlFiles({\n  file,\n  manifest,\n  destFile,\n  baseUrl\n}) {\n  const fileContents = fs.readFileSync(file, {\n    encoding: \"utf8\"\n  });\n  const dom = new JSDOM(fileContents, {\n    includeNodeLocations: true\n  });\n  const newDom = rewriteScripts({\n    dom,\n    manifest,\n    baseUrl\n  });\n  fs.writeFileSync(destFile, newDom.serialize(), \"utf8\");\n}\n/**\n * Rewrites the scripts of a given JSDOM instance to use files from the manifest\n * @param {Object} params\n * @param {JSDOM} params.dom - An instance of JSDOM\n * @param {ManifestObject} params.manifest - Manifest file parsed to Object\n * @returns {string} Returns a string from serializing JSDOM\n */\n\nexport function rewriteScripts({\n  dom,\n  manifest,\n  baseUrl\n}) {\n  const domDocument = dom.window.document;\n  const scripts = domDocument.querySelectorAll(\"script\");\n  const unhashedEntrypoints = Object.keys(manifest.entrypoints).map(fileName => {\n    return parseHashFileName(manifest.entrypoints[fileName][\"js\"]);\n  });\n  scripts.forEach(script => {\n    if (!isEntrypoint({\n      entrypoints: unhashedEntrypoints,\n      script\n    })) {\n      return;\n    }\n\n    const baseFile = path.parse(script.src).name;\n    const jsFile = manifest.entrypoints[baseFile].js;\n    script.src = fixUrl({\n      baseUrl,\n      file: jsFile\n    });\n    const cssFile = manifest.entrypoints[baseFile].css;\n\n    if (cssFile == undefined) {\n      return;\n    }\n\n    const stylesheet = domDocument.createElement(\"link\");\n    stylesheet.rel = \"stylesheet\";\n    stylesheet.href = fixUrl({\n      baseUrl,\n      file: cssFile\n    });\n    insertBefore(script, stylesheet);\n  });\n  return dom;\n}\n\nfunction fixUrl({\n  baseUrl,\n  file\n}) {\n  return prependSlash(pathToUnix(path.join(baseUrl, file)));\n}\n\nfunction insertBefore(existingNode, newNode) {\n  existingNode.parentNode.insertBefore(newNode, existingNode);\n}\n\nfunction isEntrypoint({\n  entrypoints,\n  script\n}) {\n  // Remove trailing slashes\n  script.src.replace(/\\/$/, \"\");\n\n  if (entrypoints.includes(script.src)) {\n    return true;\n  } // Account for src=\"entrypoints/blah\"\n\n\n  if (entrypoints.includes(\"/\" + script.src)) {\n    script.src = \"/\" + script.src;\n    return true;\n  }\n\n  return false;\n}","import rollup from \"rollup\";\nimport fs from \"fs-extra\";\nimport path from \"path\";\nimport glob from \"glob\";\nimport os from \"os\";\nimport { defaultInputOptions, defaultOutputOptions } from \"./options.js\";\nimport { proxyImportResolver } from \"./proxyImportResolver.js\";\nimport { addToManifest } from \"./manifestUtils.js\";\nimport { emitHtmlFiles } from \"./emitHtmlFiles.js\";\nimport { pathToUnix } from \"./utils.js\";\nconst TMP_BUILD_DIRECTORY = path.join(os.tmpdir(), \"build\");\n\nfunction getEntrypoints({\n  entrypoints,\n  buildDirectory\n}) {\n  if (typeof entrypoints === \"string\") {\n    const obj = {};\n    glob.sync(entrypoints).forEach(file => {\n      const {\n        dir,\n        name\n      } = path.parse(file); // This fixes issues that were causing x.js-[hash].js\n\n      const fileWithoutExt = path.join(dir, name);\n      const buildFile = pathToUnix(path.relative(buildDirectory, fileWithoutExt));\n      obj[buildFile] = file;\n    });\n    return obj;\n  }\n\n  return entrypoints;\n}\n\nasync function rollupBuild({\n  snowpackConfig,\n  pluginOptions,\n  inputOptions,\n  outputOptions\n}) {\n  const baseUrl = snowpackConfig.devOptions.baseUrl || \"/\";\n  const TMP_DEBUG_DIRECTORY = path.join(os.tmpdir(), \"_source_\");\n  const buildDirectory = outputOptions.dir;\n  outputOptions.dir = TMP_BUILD_DIRECTORY;\n  const entrypoints = getEntrypoints({\n    entrypoints: pluginOptions.entrypoints,\n    buildDirectory\n  });\n  inputOptions.input = inputOptions.input || entrypoints;\n  const bundle = await rollup.rollup(inputOptions);\n  const {\n    output\n  } = await bundle.generate(outputOptions);\n  const manifest = {};\n\n  for (const chunkOrAsset of output) {\n    if (chunkOrAsset.isEntry || chunkOrAsset.type === \"asset\") {\n      addToManifest({\n        manifest,\n        chunkOrAsset,\n        assignTo: \"entrypoints\"\n      });\n      continue;\n    }\n\n    addToManifest({\n      manifest,\n      chunkOrAsset,\n      assignTo: \"chunks\"\n    });\n  }\n\n  await bundle.write(outputOptions); // Add assets to manifest, use path.relative to fix minor issues\n\n  glob.sync(`${TMP_BUILD_DIRECTORY}/**/*.*`).forEach(fileName => {\n    fileName = pathToUnix(path.relative(TMP_BUILD_DIRECTORY, fileName));\n    const chunkOrAsset = {\n      fileName,\n      map: null\n    };\n    addToManifest({\n      manifest,\n      chunkOrAsset,\n      assignTo: \"assets\",\n      useFileType: false\n    });\n  });\n  const manifestJSON = JSON.stringify(manifest, null, 2);\n  fs.writeFileSync(path.join(TMP_BUILD_DIRECTORY, \"manifest.json\"), manifestJSON); // HTML files will not be pulled in by rollup, its up to us\n  // to manually pull them in.\n\n  if (pluginOptions.emitHtmlFiles === true) {\n    glob.sync(buildDirectory + \"/**/*.html\").forEach(file => {\n      let destFile = path.relative(buildDirectory, file);\n      destFile = path.resolve(TMP_BUILD_DIRECTORY, destFile);\n      const destDir = path.parse(destFile).dir;\n\n      if (!fs.existsSync(destDir)) {\n        fs.mkdirSync(destDir, {\n          recursive: true\n        });\n      }\n\n      emitHtmlFiles({\n        file,\n        manifest,\n        destFile,\n        baseUrl\n      });\n    });\n  }\n\n  await fs.remove(TMP_DEBUG_DIRECTORY);\n  await fs.mkdirp(TMP_DEBUG_DIRECTORY);\n  await fs.move(buildDirectory, TMP_DEBUG_DIRECTORY, {\n    overwrite: true\n  });\n  await fs.move(TMP_BUILD_DIRECTORY, buildDirectory, {\n    overwrite: true\n  });\n\n  if (pluginOptions.preserveSourceFiles === true) {\n    const buildDebugDir = path.join(buildDirectory, \"_source_\");\n    await fs.move(TMP_DEBUG_DIRECTORY + \"/\", buildDebugDir, {\n      overwrite: true\n    });\n  }\n}\n\nconst plugin = (snowpackConfig, pluginOptions = {}) => {\n  snowpackConfig.buildOptions.minify = false; // Let rollup handle this\n\n  snowpackConfig.buildOptions.clean = true;\n  return {\n    name: \"snowpack-plugin-rollup-bundle\",\n\n    async optimize({\n      buildDirectory\n    }) {\n      const inputOptions = defaultInputOptions({\n        buildDirectory,\n        tmpDir: TMP_BUILD_DIRECTORY,\n        sourcemap: snowpackConfig.buildOptions.sourcemap\n      });\n      const outputOptions = defaultOutputOptions(buildDirectory);\n\n      let extendConfig = cfg => cfg;\n\n      if (typeof pluginOptions.extendConfig === \"function\") {\n        extendConfig = pluginOptions.extendConfig;\n      } else if (typeof pluginOptions.extendConfig === \"object\") {\n        extendConfig = cfg => ({ ...cfg,\n          ...pluginOptions.extendConfig\n        });\n      }\n\n      const extendedConfig = await extendConfig({\n        snowpackConfig: { ...snowpackConfig\n        },\n        pluginOptions: { ...pluginOptions\n        },\n        inputOptions: { ...inputOptions\n        },\n        outputOptions: { ...outputOptions\n        }\n      }); // Rewrite \"proxy.js\" imports prior to building\n\n      glob.sync(buildDirectory + \"/**/*.js\", {\n        nodir: true\n      }).forEach(file => {\n        const resolvedImports = proxyImportResolver(fs.readFileSync(file, \"utf8\"));\n        fs.writeFileSync(file, resolvedImports, \"utf8\");\n      });\n      await rollupBuild(extendedConfig);\n    }\n\n  };\n};\n\nexport default plugin;"],"names":["defaultInputOptions","buildDirectory","tmpDir","sourcemap","plugins","resolve","browser","styles","mode","autoModules","id","includes","minimize","sourceMap","url","include","exclude","destDir","path","sourceDir","limit","fileName","commonjs","push","sourcemaps","defaultOutputOptions","format","terser","manualChunks","parse","name","assetFileNames","chunkFileNames","compact","entryFileNames","dir","proxyImportResolver","source","regex","replace","fullMatch","originalExt","pathToUnix","filePath","sep","parseHashFileName","base","fileWithoutHash","join","prependSlash","addToManifest","manifest","chunkOrAsset","assignTo","useFileType","asset","assignment","assignAsset","obj","map","fileType","extType","baseName","undefined","startsWith","split","slice","adjustedFileName","mapFile","endsWith","emitHtmlFiles","file","destFile","baseUrl","fileContents","fs","readFileSync","encoding","dom","JSDOM","includeNodeLocations","newDom","rewriteScripts","writeFileSync","serialize","domDocument","window","document","scripts","querySelectorAll","unhashedEntrypoints","Object","keys","entrypoints","forEach","script","isEntrypoint","baseFile","src","jsFile","js","fixUrl","cssFile","css","stylesheet","createElement","rel","href","insertBefore","existingNode","newNode","parentNode","TMP_BUILD_DIRECTORY","os","tmpdir","getEntrypoints","glob","sync","fileWithoutExt","buildFile","relative","rollupBuild","snowpackConfig","pluginOptions","inputOptions","outputOptions","devOptions","TMP_DEBUG_DIRECTORY","input","bundle","rollup","output","generate","isEntry","type","write","manifestJSON","JSON","stringify","existsSync","mkdirSync","recursive","remove","mkdirp","move","overwrite","preserveSourceFiles","buildDebugDir","plugin","buildOptions","minify","clean","optimize","extendConfig","cfg","extendedConfig","nodir","resolvedImports"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAQO,SAASA,mBAAT,CAA6B;AAClCC,EAAAA,cADkC;AAElCC,EAAAA,MAFkC;AAGlCC,EAAAA;AAHkC,CAA7B,EAIJ;AACD,QAAMC,OAAO,GAAG,CAACC,OAAO,CAAC;AACvBC,IAAAA,OAAO,EAAE;AADc,GAAD,CAAR,EAEZC,MAAM,CAAC;AACTC,IAAAA,IAAI,EAAE,CAAC,SAAD,EAAY,SAAZ,CADG;AAETC,IAAAA,WAAW,EAAEC,EAAE,IAAIA,EAAE,CAACC,QAAH,CAAY,aAAZ,CAFV;AAGTC,IAAAA,QAAQ,EAAE,IAHD;AAITC,IAAAA,SAAS,EAAEV;AAJF,GAAD,CAFM,EAOZW,GAAG,CAAC;AACNC,IAAAA,OAAO,EAAE,MADH;AAENC,IAAAA,OAAO,EAAE,oBAFH;AAGNC,IAAAA,OAAO,EAAEC,IAAI,CAACb,OAAL,CAAaH,MAAb,CAHH;AAINiB,IAAAA,SAAS,EAAED,IAAI,CAACb,OAAL,CAAaJ,cAAb,CAJL;AAKNmB,IAAAA,KAAK,EAAE,CALD;AAMN;AACAC,IAAAA,QAAQ,EAAE;AAPJ,GAAD,CAPS,EAeZC,QAAQ,EAfI,CAAhB;;AAiBA,MAAInB,SAAJ,EAAe;AACbC,IAAAA,OAAO,CAACmB,IAAR,CAAaC,UAAU,EAAvB;AACD;;AAED,SAAO;AACLpB,IAAAA;AADK,GAAP;AAGD;AACM,SAASqB,oBAAT,CAA8BxB,cAA9B,EAA8C;AACnD,SAAO;AACLyB,IAAAA,MAAM,EAAE,IADH;AAELtB,IAAAA,OAAO,EAAE,CAACuB,yBAAM,EAAP,CAFJ;AAGLC,IAAAA,YAAY,EAAElB,EAAE,IAAI;AAClB,UAAIA,EAAE,CAACC,QAAH,CAAY,aAAZ,CAAJ,EAAgC;AAC9B,eAAOO,IAAI,CAACW,KAAL,CAAWnB,EAAX,EAAeoB,IAAtB;AACD;AACF,KAPI;AAQLC,IAAAA,cAAc,EAAE,yBARX;AASLC,IAAAA,cAAc,EAAE,+BATX;AAULC,IAAAA,OAAO,EAAE,IAVJ;AAWL9B,IAAAA,SAAS,EAAE,IAXN;AAYL+B,IAAAA,cAAc,EAAE,kBAZX;AAaLC,IAAAA,GAAG,EAAElC;AAbA,GAAP;AAeD;;ACtDD;AACA,AAAO,SAASmC,mBAAT,CAA6BC,MAA7B,EAAqC;AAC1C,QAAMC,KAAK,GAAG,uCAAd;AACA,SAAOD,MAAM,CAACE,OAAP,CAAeD,KAAf,EAAsB,CAACE,SAAD,EAAYC,WAAZ,KAA4B;AACvD;AACA,QAAIA,WAAW,KAAK,MAApB,EAA4B;AAC1B,aAAOD,SAAP;AACD;;AAED,WAAOA,SAAS,CAACD,OAAV,CAAkB,WAAlB,EAA+B,EAA/B,CAAP;AACD,GAPM,CAAP;AAQD;;ACTD;AACA;AACA;AACA;;AAEA,AAAO,SAASG,UAAT,CAAoBC,QAApB,EAA8B;AACnC,MAAIzB,IAAI,CAAC0B,GAAL,KAAa,IAAjB,EAAuB;AACrB,WAAOD,QAAQ,CAACJ,OAAT,CAAiB,KAAjB,EAAwB,GAAxB,CAAP;AACD;;AAED,SAAOI,QAAP;AACD;AACD,AAAO,SAASE,iBAAT,CAA2BF,QAA3B,EAAqC;AAC1C,QAAM;AACJR,IAAAA,GADI;AAEJW,IAAAA;AAFI,MAGF5B,IAAI,CAACW,KAAL,CAAWc,QAAX,CAHJ;AAIA,QAAMI,eAAe,GAAGD,IAAI,CAACP,OAAL,CAAa,kBAAb,EAAiC,MAAjC,CAAxB;AACA,SAAOG,UAAU,CAACxB,IAAI,CAAC8B,IAAL,CAAUb,GAAV,EAAeY,eAAf,CAAD,CAAjB;AACD;AACD,AAMO,SAASE,YAAT,CAAsB5B,QAAtB,EAAgC;AACrC,MAAIA,QAAQ,CAAC,CAAD,CAAR,KAAgB,GAApB,EAAyB;AACvB,WAAOA,QAAP;AACD;;AAED,SAAO,MAAMA,QAAb;AACD;;AChCM,SAAS6B,aAAT,CAAuB;AAC5BC,EAAAA,QAD4B;AAE5BC,EAAAA,YAF4B;AAG5BC,EAAAA,QAH4B;AAI5BC,EAAAA,WAAW,GAAG;AAJc,CAAvB,EAKJ;AACD,QAAM;AACJjC,IAAAA;AADI,MAEF+B,YAFJ;AAGA,QAAMG,KAAK,GAAGH,YAAd;AACA,QAAMI,UAAU,GAAGH,QAAnB;AACAF,EAAAA,QAAQ,CAACN,iBAAiB,CAACxB,QAAD,CAAlB,CAAR,GAAwC4B,YAAY,CAAC5B,QAAD,CAApD;AACA8B,EAAAA,QAAQ,CAACK,UAAD,CAAR,GAAuBL,QAAQ,CAACK,UAAD,CAAR,IAAwB,EAA/C;AACAC,EAAAA,WAAW,CAAC;AACVC,IAAAA,GAAG,EAAEP,QAAQ,CAACK,UAAD,CADH;AAEVD,IAAAA,KAFU;AAGVD,IAAAA;AAHU,GAAD,CAAX;AAKD;;AAED,SAASG,WAAT,CAAqB;AACnBC,EAAAA,GADmB;AAEnBH,EAAAA,KAFmB;AAGnBD,EAAAA;AAHmB,CAArB,EAIG;AACD,QAAM;AACJK,IAAAA,GADI;AAEJtC,IAAAA;AAFI,MAGFkC,KAHJ;AAIA,MAAIK,QAAQ,GAAGC,OAAO,CAACxC,QAAD,CAAtB;AACA,MAAIyC,QAAJ;AACAA,EAAAA,QAAQ,GAAGjB,iBAAiB,CAACxB,QAAD,CAA5B;;AAEA,MAAIyC,QAAQ,KAAKC,SAAjB,EAA4B;AAC1B;AACD,GAXA;;;AAcD,MAAIH,QAAQ,KAAK,IAAjB,EAAuB;AACrB;AACA,QAAI;AACFzB,MAAAA,GADE;AAEFL,MAAAA;AAFE,QAGAZ,IAAI,CAACW,KAAL,CAAWiC,QAAX,CAHJ;;AAKA,QAAIF,QAAQ,CAACI,UAAT,CAAoB,KAApB,CAAJ,EAAgC;AAC9B7B,MAAAA,GAAG,GAAGA,GAAG,CAAC8B,KAAJ,CAAU,GAAV,EAAeC,KAAf,CAAqB,CAArB,EAAwBlB,IAAxB,CAA6B,EAA7B,CAAN;AACD,KAFD,MAEO,IAAIY,QAAQ,CAACI,UAAT,CAAoB,IAApB,CAAJ,EAA+B;AACpC7B,MAAAA,GAAG,GAAGA,GAAG,CAAC8B,KAAJ,CAAU,GAAV,EAAeC,KAAf,CAAqB,CAArB,EAAwBlB,IAAxB,CAA6B,EAA7B,CAAN;AACD;;AAEDc,IAAAA,QAAQ,GAAGpB,UAAU,CAACxB,IAAI,CAAC8B,IAAL,CAAUb,GAAV,EAAeL,IAAI,CAACmC,KAAL,CAAW,GAAX,EAAgB,CAAhB,CAAf,CAAD,CAArB;AACD;;AAED,QAAME,gBAAgB,GAAGlB,YAAY,CAAC5B,QAAD,CAArC;AACAqC,EAAAA,GAAG,CAACI,QAAD,CAAH,GAAgBJ,GAAG,CAACI,QAAD,CAAH,IAAiB,EAAjC;;AAEA,MAAIR,WAAW,KAAK,KAApB,EAA2B;AACzBI,IAAAA,GAAG,CAACI,QAAD,CAAH,GAAgBK,gBAAhB;AACA;AACD;;AAEDT,EAAAA,GAAG,CAACI,QAAD,CAAH,CAAcF,QAAd,IAA0BO,gBAA1B;;AAEA,MAAIR,GAAJ,EAAS;AACP,UAAMS,OAAO,GAAGD,gBAAgB,GAAG,MAAnC;AACAP,IAAAA,QAAQ,GAAGC,OAAO,CAACO,OAAD,CAAlB;AACAV,IAAAA,GAAG,CAACI,QAAD,CAAH,CAAcF,QAAd,IAA0BQ,OAA1B;AACD;AACF;;AAED,SAASP,OAAT,CAAiBxC,QAAjB,EAA2B;AACzB,MAAIA,QAAQ,CAACgD,QAAT,CAAkB,UAAlB,CAAJ,EAAmC;AACjC,WAAO,SAAP;AACD,GAFD,MAEO,IAAIhD,QAAQ,CAACgD,QAAT,CAAkB,MAAlB,CAAJ,EAA+B;AACpC,WAAO,KAAP;AACD,GAFM,MAEA,IAAIhD,QAAQ,CAACgD,QAAT,CAAkB,SAAlB,CAAJ,EAAkC;AACvC,WAAO,QAAP;AACD,GAFM,MAEA,IAAIhD,QAAQ,CAACgD,QAAT,CAAkB,KAAlB,CAAJ,EAA8B;AACnC,WAAO,IAAP;AACD;;AAED,SAAO,IAAP;AACD;;ACjFD;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,AAAO,SAASC,aAAT,CAAuB;AAC5BC,EAAAA,IAD4B;AAE5BpB,EAAAA,QAF4B;AAG5BqB,EAAAA,QAH4B;AAI5BC,EAAAA;AAJ4B,CAAvB,EAKJ;AACD,QAAMC,YAAY,GAAGC,IAAE,CAACC,YAAH,CAAgBL,IAAhB,EAAsB;AACzCM,IAAAA,QAAQ,EAAE;AAD+B,GAAtB,CAArB;AAGA,QAAMC,GAAG,GAAG,IAAIC,WAAJ,CAAUL,YAAV,EAAwB;AAClCM,IAAAA,oBAAoB,EAAE;AADY,GAAxB,CAAZ;AAGA,QAAMC,MAAM,GAAGC,cAAc,CAAC;AAC5BJ,IAAAA,GAD4B;AAE5B3B,IAAAA,QAF4B;AAG5BsB,IAAAA;AAH4B,GAAD,CAA7B;AAKAE,EAAAA,IAAE,CAACQ,aAAH,CAAiBX,QAAjB,EAA2BS,MAAM,CAACG,SAAP,EAA3B,EAA+C,MAA/C;AACD;AACD;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,AAAO,SAASF,cAAT,CAAwB;AAC7BJ,EAAAA,GAD6B;AAE7B3B,EAAAA,QAF6B;AAG7BsB,EAAAA;AAH6B,CAAxB,EAIJ;AACD,QAAMY,WAAW,GAAGP,GAAG,CAACQ,MAAJ,CAAWC,QAA/B;AACA,QAAMC,OAAO,GAAGH,WAAW,CAACI,gBAAZ,CAA6B,QAA7B,CAAhB;AACA,QAAMC,mBAAmB,GAAGC,MAAM,CAACC,IAAP,CAAYzC,QAAQ,CAAC0C,WAArB,EAAkClC,GAAlC,CAAsCtC,QAAQ,IAAI;AAC5E,WAAOwB,iBAAiB,CAACM,QAAQ,CAAC0C,WAAT,CAAqBxE,QAArB,EAA+B,IAA/B,CAAD,CAAxB;AACD,GAF2B,CAA5B;AAGAmE,EAAAA,OAAO,CAACM,OAAR,CAAgBC,MAAM,IAAI;AACxB,QAAI,CAACC,YAAY,CAAC;AAChBH,MAAAA,WAAW,EAAEH,mBADG;AAEhBK,MAAAA;AAFgB,KAAD,CAAjB,EAGI;AACF;AACD;;AAED,UAAME,QAAQ,GAAG/E,IAAI,CAACW,KAAL,CAAWkE,MAAM,CAACG,GAAlB,EAAuBpE,IAAxC;AACA,UAAMqE,MAAM,GAAGhD,QAAQ,CAAC0C,WAAT,CAAqBI,QAArB,EAA+BG,EAA9C;AACAL,IAAAA,MAAM,CAACG,GAAP,GAAaG,MAAM,CAAC;AAClB5B,MAAAA,OADkB;AAElBF,MAAAA,IAAI,EAAE4B;AAFY,KAAD,CAAnB;AAIA,UAAMG,OAAO,GAAGnD,QAAQ,CAAC0C,WAAT,CAAqBI,QAArB,EAA+BM,GAA/C;;AAEA,QAAID,OAAO,IAAIvC,SAAf,EAA0B;AACxB;AACD;;AAED,UAAMyC,UAAU,GAAGnB,WAAW,CAACoB,aAAZ,CAA0B,MAA1B,CAAnB;AACAD,IAAAA,UAAU,CAACE,GAAX,GAAiB,YAAjB;AACAF,IAAAA,UAAU,CAACG,IAAX,GAAkBN,MAAM,CAAC;AACvB5B,MAAAA,OADuB;AAEvBF,MAAAA,IAAI,EAAE+B;AAFiB,KAAD,CAAxB;AAIAM,IAAAA,YAAY,CAACb,MAAD,EAASS,UAAT,CAAZ;AACD,GA3BD;AA4BA,SAAO1B,GAAP;AACD;;AAED,SAASuB,MAAT,CAAgB;AACd5B,EAAAA,OADc;AAEdF,EAAAA;AAFc,CAAhB,EAGG;AACD,SAAOtB,YAAY,CAACP,UAAU,CAACxB,IAAI,CAAC8B,IAAL,CAAUyB,OAAV,EAAmBF,IAAnB,CAAD,CAAX,CAAnB;AACD;;AAED,SAASqC,YAAT,CAAsBC,YAAtB,EAAoCC,OAApC,EAA6C;AAC3CD,EAAAA,YAAY,CAACE,UAAb,CAAwBH,YAAxB,CAAqCE,OAArC,EAA8CD,YAA9C;AACD;;AAED,SAASb,YAAT,CAAsB;AACpBH,EAAAA,WADoB;AAEpBE,EAAAA;AAFoB,CAAtB,EAGG;AACD;AACAA,EAAAA,MAAM,CAACG,GAAP,CAAW3D,OAAX,CAAmB,KAAnB,EAA0B,EAA1B;;AAEA,MAAIsD,WAAW,CAAClF,QAAZ,CAAqBoF,MAAM,CAACG,GAA5B,CAAJ,EAAsC;AACpC,WAAO,IAAP;AACD,GANA;;;AASD,MAAIL,WAAW,CAAClF,QAAZ,CAAqB,MAAMoF,MAAM,CAACG,GAAlC,CAAJ,EAA4C;AAC1CH,IAAAA,MAAM,CAACG,GAAP,GAAa,MAAMH,MAAM,CAACG,GAA1B;AACA,WAAO,IAAP;AACD;;AAED,SAAO,KAAP;AACD;;AChHD,MAAMc,mBAAmB,GAAG9F,IAAI,CAAC8B,IAAL,CAAUiE,EAAE,CAACC,MAAH,EAAV,EAAuB,OAAvB,CAA5B;;AAEA,SAASC,cAAT,CAAwB;AACtBtB,EAAAA,WADsB;AAEtB5F,EAAAA;AAFsB,CAAxB,EAGG;AACD,MAAI,OAAO4F,WAAP,KAAuB,QAA3B,EAAqC;AACnC,UAAMnC,GAAG,GAAG,EAAZ;AACA0D,IAAAA,IAAI,CAACC,IAAL,CAAUxB,WAAV,EAAuBC,OAAvB,CAA+BvB,IAAI,IAAI;AACrC,YAAM;AACJpC,QAAAA,GADI;AAEJL,QAAAA;AAFI,UAGFZ,IAAI,CAACW,KAAL,CAAW0C,IAAX,CAHJ,CADqC;;AAMrC,YAAM+C,cAAc,GAAGpG,IAAI,CAAC8B,IAAL,CAAUb,GAAV,EAAeL,IAAf,CAAvB;AACA,YAAMyF,SAAS,GAAG7E,UAAU,CAACxB,IAAI,CAACsG,QAAL,CAAcvH,cAAd,EAA8BqH,cAA9B,CAAD,CAA5B;AACA5D,MAAAA,GAAG,CAAC6D,SAAD,CAAH,GAAiBhD,IAAjB;AACD,KATD;AAUA,WAAOb,GAAP;AACD;;AAED,SAAOmC,WAAP;AACD;;AAED,eAAe4B,WAAf,CAA2B;AACzBC,EAAAA,cADyB;AAEzBC,EAAAA,aAFyB;AAGzBC,EAAAA,YAHyB;AAIzBC,EAAAA;AAJyB,CAA3B,EAKG;AACD,QAAMpD,OAAO,GAAGiD,cAAc,CAACI,UAAf,CAA0BrD,OAA1B,IAAqC,GAArD;AACA,QAAMsD,mBAAmB,GAAG7G,IAAI,CAAC8B,IAAL,CAAUiE,EAAE,CAACC,MAAH,EAAV,EAAuB,UAAvB,CAA5B;AACA,QAAMjH,cAAc,GAAG4H,aAAa,CAAC1F,GAArC;AACA0F,EAAAA,aAAa,CAAC1F,GAAd,GAAoB6E,mBAApB;AACA,QAAMnB,WAAW,GAAGsB,cAAc,CAAC;AACjCtB,IAAAA,WAAW,EAAE8B,aAAa,CAAC9B,WADM;AAEjC5F,IAAAA;AAFiC,GAAD,CAAlC;AAIA2H,EAAAA,YAAY,CAACI,KAAb,GAAqBJ,YAAY,CAACI,KAAb,IAAsBnC,WAA3C;AACA,QAAMoC,MAAM,GAAG,MAAMC,MAAM,CAACA,MAAP,CAAcN,YAAd,CAArB;AACA,QAAM;AACJO,IAAAA;AADI,MAEF,MAAMF,MAAM,CAACG,QAAP,CAAgBP,aAAhB,CAFV;AAGA,QAAM1E,QAAQ,GAAG,EAAjB;;AAEA,OAAK,MAAMC,YAAX,IAA2B+E,MAA3B,EAAmC;AACjC,QAAI/E,YAAY,CAACiF,OAAb,IAAwBjF,YAAY,CAACkF,IAAb,KAAsB,OAAlD,EAA2D;AACzDpF,MAAAA,aAAa,CAAC;AACZC,QAAAA,QADY;AAEZC,QAAAA,YAFY;AAGZC,QAAAA,QAAQ,EAAE;AAHE,OAAD,CAAb;AAKA;AACD;;AAEDH,IAAAA,aAAa,CAAC;AACZC,MAAAA,QADY;AAEZC,MAAAA,YAFY;AAGZC,MAAAA,QAAQ,EAAE;AAHE,KAAD,CAAb;AAKD;;AAED,QAAM4E,MAAM,CAACM,KAAP,CAAaV,aAAb,CAAN,CAjCC;;AAmCDT,EAAAA,IAAI,CAACC,IAAL,CAAW,GAAEL,mBAAoB,SAAjC,EAA2ClB,OAA3C,CAAmDzE,QAAQ,IAAI;AAC7DA,IAAAA,QAAQ,GAAGqB,UAAU,CAACxB,IAAI,CAACsG,QAAL,CAAcR,mBAAd,EAAmC3F,QAAnC,CAAD,CAArB;AACA,UAAM+B,YAAY,GAAG;AACnB/B,MAAAA,QADmB;AAEnBsC,MAAAA,GAAG,EAAE;AAFc,KAArB;AAIAT,IAAAA,aAAa,CAAC;AACZC,MAAAA,QADY;AAEZC,MAAAA,YAFY;AAGZC,MAAAA,QAAQ,EAAE,QAHE;AAIZC,MAAAA,WAAW,EAAE;AAJD,KAAD,CAAb;AAMD,GAZD;AAaA,QAAMkF,YAAY,GAAGC,IAAI,CAACC,SAAL,CAAevF,QAAf,EAAyB,IAAzB,EAA+B,CAA/B,CAArB;AACAwB,EAAAA,EAAE,CAACQ,aAAH,CAAiBjE,IAAI,CAAC8B,IAAL,CAAUgE,mBAAV,EAA+B,eAA/B,CAAjB,EAAkEwB,YAAlE,EAjDC;AAkDD;;AAEA,MAAIb,aAAa,CAACrD,aAAd,KAAgC,IAApC,EAA0C;AACxC8C,IAAAA,IAAI,CAACC,IAAL,CAAUpH,cAAc,GAAG,YAA3B,EAAyC6F,OAAzC,CAAiDvB,IAAI,IAAI;AACvD,UAAIC,QAAQ,GAAGtD,IAAI,CAACsG,QAAL,CAAcvH,cAAd,EAA8BsE,IAA9B,CAAf;AACAC,MAAAA,QAAQ,GAAGtD,IAAI,CAACb,OAAL,CAAa2G,mBAAb,EAAkCxC,QAAlC,CAAX;AACA,YAAMvD,OAAO,GAAGC,IAAI,CAACW,KAAL,CAAW2C,QAAX,EAAqBrC,GAArC;;AAEA,UAAI,CAACwC,EAAE,CAACgE,UAAH,CAAc1H,OAAd,CAAL,EAA6B;AAC3B0D,QAAAA,EAAE,CAACiE,SAAH,CAAa3H,OAAb,EAAsB;AACpB4H,UAAAA,SAAS,EAAE;AADS,SAAtB;AAGD;;AAEDvE,MAAAA,aAAa,CAAC;AACZC,QAAAA,IADY;AAEZpB,QAAAA,QAFY;AAGZqB,QAAAA,QAHY;AAIZC,QAAAA;AAJY,OAAD,CAAb;AAMD,KAjBD;AAkBD;;AAED,QAAME,EAAE,CAACmE,MAAH,CAAUf,mBAAV,CAAN;AACA,QAAMpD,EAAE,CAACoE,MAAH,CAAUhB,mBAAV,CAAN;AACA,QAAMpD,EAAE,CAACqE,IAAH,CAAQ/I,cAAR,EAAwB8H,mBAAxB,EAA6C;AACjDkB,IAAAA,SAAS,EAAE;AADsC,GAA7C,CAAN;AAGA,QAAMtE,EAAE,CAACqE,IAAH,CAAQhC,mBAAR,EAA6B/G,cAA7B,EAA6C;AACjDgJ,IAAAA,SAAS,EAAE;AADsC,GAA7C,CAAN;;AAIA,MAAItB,aAAa,CAACuB,mBAAd,KAAsC,IAA1C,EAAgD;AAC9C,UAAMC,aAAa,GAAGjI,IAAI,CAAC8B,IAAL,CAAU/C,cAAV,EAA0B,UAA1B,CAAtB;AACA,UAAM0E,EAAE,CAACqE,IAAH,CAAQjB,mBAAmB,GAAG,GAA9B,EAAmCoB,aAAnC,EAAkD;AACtDF,MAAAA,SAAS,EAAE;AAD2C,KAAlD,CAAN;AAGD;AACF;;AAED,MAAMG,MAAM,GAAG,CAAC1B,cAAD,EAAiBC,aAAa,GAAG,EAAjC,KAAwC;AACrDD,EAAAA,cAAc,CAAC2B,YAAf,CAA4BC,MAA5B,GAAqC,KAArC,CADqD;;AAGrD5B,EAAAA,cAAc,CAAC2B,YAAf,CAA4BE,KAA5B,GAAoC,IAApC;AACA,SAAO;AACLzH,IAAAA,IAAI,EAAE,+BADD;;AAGL,UAAM0H,QAAN,CAAe;AACbvJ,MAAAA;AADa,KAAf,EAEG;AACD,YAAM2H,YAAY,GAAG5H,mBAAmB,CAAC;AACvCC,QAAAA,cADuC;AAEvCC,QAAAA,MAAM,EAAE8G,mBAF+B;AAGvC7G,QAAAA,SAAS,EAAEuH,cAAc,CAAC2B,YAAf,CAA4BlJ;AAHA,OAAD,CAAxC;AAKA,YAAM0H,aAAa,GAAGpG,oBAAoB,CAACxB,cAAD,CAA1C;;AAEA,UAAIwJ,YAAY,GAAGC,GAAG,IAAIA,GAA1B;;AAEA,UAAI,OAAO/B,aAAa,CAAC8B,YAArB,KAAsC,UAA1C,EAAsD;AACpDA,QAAAA,YAAY,GAAG9B,aAAa,CAAC8B,YAA7B;AACD,OAFD,MAEO,IAAI,OAAO9B,aAAa,CAAC8B,YAArB,KAAsC,QAA1C,EAAoD;AACzDA,QAAAA,YAAY,GAAGC,GAAG,sCAAUA,GAAV,GACb/B,aAAa,CAAC8B,YADD,CAAlB;AAGD;;AAED,YAAME,cAAc,GAAG,MAAMF,YAAY,CAAC;AACxC/B,QAAAA,cAAc,qBAAOA,cAAP,CAD0B;AAGxCC,QAAAA,aAAa,qBAAOA,aAAP,CAH2B;AAKxCC,QAAAA,YAAY,qBAAOA,YAAP,CAL4B;AAOxCC,QAAAA,aAAa,qBAAOA,aAAP;AAP2B,OAAD,CAAzC,CAlBC;;AA6BDT,MAAAA,IAAI,CAACC,IAAL,CAAUpH,cAAc,GAAG,UAA3B,EAAuC;AACrC2J,QAAAA,KAAK,EAAE;AAD8B,OAAvC,EAEG9D,OAFH,CAEWvB,IAAI,IAAI;AACjB,cAAMsF,eAAe,GAAGzH,mBAAmB,CAACuC,EAAE,CAACC,YAAH,CAAgBL,IAAhB,EAAsB,MAAtB,CAAD,CAA3C;AACAI,QAAAA,EAAE,CAACQ,aAAH,CAAiBZ,IAAjB,EAAuBsF,eAAvB,EAAwC,MAAxC;AACD,OALD;AAMA,YAAMpC,WAAW,CAACkC,cAAD,CAAjB;AACD;;AAzCI,GAAP;AA4CD,CAhDD;;;;"}